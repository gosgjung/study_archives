# 쿠버네티스의 볼륨, 퍼시스턴트 볼륨/퍼시스턴트 볼륨 클레임



# 1. 쿠버네티스의 볼륨이란?

컨테이너는 기본적으로 상태가 없는(stateless) 앱 컨테이너를 사용한다.

하지만, 항상 상태 없는 앱 컨테이너만 운영할 수는 없다.

컨테이너가 종료되더라도 디스크에 기록으로 남겨놓아 재기동을 하더라도 이 기록을 기반으로 구동되도록 해야 하는 경우도 있다.

(ex. MySQL 컨테이너, 젠킨스)

이렇게 호스트 또는 컨테이너의 디스크 또는 물리 경로를 사용하는 방식에는 일반적으로 볼륨을 사용한다고 한다. 쿠버네티스 쪽에서는 통상적으로 볼륨서비스라고 부른다. 

# 2. 볼륨 서비스의 종류들

쿠버네티스가 지원하는 볼륨 플러그인의 종류는 아래와 같이 매우 다양하다. 이 중 aws, azure, gce로 시작하는 볼륨은 클라우드 서비스에서 제공하는 볼륨서비스이다. 쿠버네티스에서는 이렇게 다양한  스토리지들을 PV로 사용할 수 있다.  단 PVC를 거쳐서 사용해야 한다.

- **awsElasticBlockStore**
- **azureDisk**
- **azureFile**
- cephfs
- configMap
- csi
- downwardAPI
- emptyDir
- fc(fibre channel)
- flocker
- **gcePersistentDisk**
- gitRepo (deprecated)
- glusterfs
- hostPath
- iscsi
- local
- nfs
- persistentVolumeClaim
- projected
- portworxVolume
- quobyte
- rbd
- scaleIO
- secret
- storageos
- vsphereVolume

  

이중에서 여기서는 볼륨/퍼시스턴트 볼륨만을 정리할 예정이다. 볼륨 중에서도 살펴볼 내용은 emptyDir, hostPath, nfs 이다.

# 3. 볼륨과 퍼시스턴트 볼륨

볼륨의 종류는 또 아래와 같은 분류로 나눌 수 있다.

- 볼륨
  - 일반 볼륨이라고 생각하면 된다. (약간의 뇌피셜)
  - 컨테이너를 재시작해도 데이터를 유지한다.
  - 종류
    - emptyDir, hostPath, local, configMap
      - 컨테이너가 실행된 노드의 디스크를 볼륨으로 사용
      - configMap도 볼륨의 한 종류라는 사실. 신기하다.
    - nfs
      - 네트워크 볼륨
- 퍼시스턴트 볼륨
  - 데이터를 저장했던 노드가 아닌 다른 노드에서 컨테이너를 재시작하더라도 데이터를 저장한 볼륨을 그대로 사용할 수 있도록 해준다.



# 4. 마운트한 볼륨의 상속관계 및 Read/Write 범위 지정

볼륨 관련 필드 중 .spec.container.volumeMounts.mountPropagation이 있다. 파드 하나에 있는 컨테이너들 끼리 또는 같은 노드에 실행된 파드들끼리 볼륨을 공유해서 사용할지를 설정한다.  

.spec.container.volumeMounts.mountPropagation에 지정할 수 있는 값(Value)는 아래의 세가지가 있다.  

- None
  - mount 를 전파(Propagation)하지 않겠다. 는 의미
  - 호스트에서 볼륨에 해당하는 디렉터리 하위에 마운트한 다른 마운트 들은 볼수 없다.
  - 컨테이너가 만들어놓은 마운트를 호스트에서 볼 수도 없다.
  - 디폴트 값이다.
- HostToContainer
  - 호스트에서 해당 볼륨 하위에 마운트된 다른 디렉터리들도 해당 볼륨에서 볼 수 있도록 한다.
- Bidirectional
  - HostToContainer 처럼 하위에 마운트된 디렉터리도 볼 수 있고
  - 호스트 안 다른 모든 컨테이너/파드에서 같은 볼륨을 사용할 수 있다.



# 5. emptyDir, hostPath, nfs

emptyDir, hostPath, nfs를 지정할때 매니페스트 파일에 지정하는 형식이다.

- .spec.volumes[]
  - 사용하려는 볼륨들을 지정해준다.
  - ex)
    - .spec.volumes[].emptyDir
    - .spec.volumes[].hostPath
    - .spec.volumes[].nfs
- .spec.containers[].volumeMounts[]
  - mountPath 에 컨테이너 내에서 사용할 디렉터리 명을 지정해준다.
  - name 필드에 볼륨의 이름을 지정해준다.



## emptyDir

- emptyDir 은 파드가 실행되는 호스트의 디스크를 임시로 컨테이너에 볼륨으로 할당해 사용할 때 사용하는 방법이다.
- 메모리와 디스크를 함께 이용하는 대용량 연산시 사용하는 편이다.
- 연산 도중 컨테이너에 문제가 발생해 재시작되더라도 파드는 살아있으므로 emptyDir에 저장해둔 데이터를 계속사용할 수 있다.

```yaml
apiVersion: v1
kind: Pod
metadata:
    name: kub-empty-examplepod
spec:
    containers:
    - name: …
      image: …
      volumeMounts:
      - mountPath: /emptydir  # 컨테이너 내의 디렉터리
        name: sample1          # 볼륨 마운트 항목의 이름
    volumes:
    - name: sample1
      emptyDir: {}            # 볼륨의 종류를 지정해준다.
```



## hostPath

- **hostPath는 파드가 실행된 호스트의 파일이나 디렉터리를 파드에 마운트한다.**
- **hostPath는 실제 호스트의 파일이나 디렉터리를 마운트한다.**

```yaml
apiVersion: v1
kind: Pod
metadata:
    name: kub-empty-examplepod
spec:
    containers:
    - name: …
      image: …
      volumeMounts:
      - mountPath: /emptydir   # 컨테이너 내의 디렉터리
        name: sample1          # 볼륨 마운트 항목의 이름
    volumes:
    - name: sample1
      hostPath: 
        path: /tmp             # 호스트 시스템내에서 매핑할 실제 디렉터리
        type: Directory        # 정책
```



## nfs

```yaml

```



# 6. 퍼시스턴트 볼륨/퍼시스턴트 볼륨 클레임

쿠버네티스에서 볼륨을 사용할 때 

- PV (퍼시스턴트 볼륨, Persistent Volume)
- PVC (퍼시스턴트 볼륨 클레임, Persistent Volume Claim)

을 함께 사용하는 편이다.



## PV,PVC 의 개념

- PV (퍼시스턴트 볼륨, Persistent Volume)
  - 볼륨 자체를 의미한다. 
  - 별도의 생명주기가 있다. 파드와는 별개로 관리된다.
  - 파드가 볼륨을 직접 할당해서 사용하지 못한다.
- PVC (퍼시스턴트 볼륨 클레임, Persistent Volume Claim)
  - 사용자가 PV에 하는 요청
  - 사용하고 싶은 용량은 얼마인지, 읽기/쓰기는 어떤 모드로 설정할지 등을 정의
  - 파드가 직접 볼륨을 직접 할당하여 사용하지 않고, 중간에 PVC를 두어 파드가 사용할 스토리지와 파드를 분리했다.
  - 조금 쉽게 이야기 하면 볼륨을 요청하는 yaml 문서라고 할수도 있다.

## PV/PVC 의 생명주기

### 프로비저닝

- PV를 만드는 단계
- PV를 만드는 방식은 정적 방법, 동적 방법이 있다.
- 정적 방법은 미리 PV의 크기를 정해 만들어두고 사용하는 방식이다.
- 동적 방법은 요청이 있을 때마다 PV를 만들어 사용하는 방식이다.
- 동적 방법은 원하는 용량 만큼 필요할 때 생성해 사용가능하다. 
- 동적 방법으로 프로비저닝할때 StorageClass로 PV를 생성한다.

### 바인딩

- 프로비저닝으로 만든 PV를 PVC와 연결하는 단계
- PVC에 명시한 용량, 접근 방식에 따라 그에 맞는 PV가 할당된다.
- PVC 요청 처리시 요청에 맞는 PV가 없다면 바인딩에 실패한다.
- PVC는 바인딩 요청이 실패하면, PV가 생길 때까지 대기하다가 PVC에 바인딩된다.
- PV 와 PVC의 관계는 1:1 관계이다.

### 사용

- 파드는 PVC를 볼륨으로 인식해 사용한다. (파드가 직접 PV를 할당하여 사용하는 것은 불가능하다. 따라서 파드에서 PV를 접근할 때 PVC를 거쳐서 사용)
- PVC는 파드를 유지하는동안 계속해서 사용가능하다. 시스템에서 강제로 삭제할수 없다.
- 사용중인 스토리지 오브젝트 보호(Storage Object in Use Protection) 기능이다.

### 반환

- 사용이 끝난 PVC는 삭제되고 초기화된다.
- 사용이 끝난 PVC를 사용하던 PV를 초기화한다.
- 이 과정을 반환 이라고한다.
- 초기화 정책은 Retain, Delete, Recycle 이 있다.

#### 반환정책#1 - Retain

PV를 그대로 보존. PVC를 삭제하면 해당 PVC가 사용하던 PV는 단지 해제(released)된 상태여서 다른 PVC가 사용가능하다. 단순 사용해제 상태이므로 PV 안의 데이터는 그대로 남아있다.  

#### 반환정책#2 - Delete

동적 볼륨할당 방식으로 프로비저닝 했을 때 생성된 PV들의 기본반환정책은 Delete이다.

PV를 삭제하고 연결된 외부 스토리지의 볼륨도 삭제.  

#### 반환정책#3 - Recycle

PV의 데이터들을 삭제하고 다시 새로운 PVC에서 PV를 사용할 수 있도록 하는 정책.

deprecated 예정인 정책...  



# 7. 퍼시스턴트 볼륨 템플릿

  

# 8. 퍼시스턴트 볼륨 클레임 템플릿













