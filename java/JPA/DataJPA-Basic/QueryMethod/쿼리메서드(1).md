# 쿼리메서드 (1)

# 1. 메소드 이름으로 쿼리 생성

Spring Data JPA 를 사용하면, 메소드 이름을 분석헤서 JPQL 쿼리를 실행할 수 있다. Emp 테이블에서 이름과 부서번호로 사원을 조회하는 경우의 예제를 들어서 정리해보려고 한다.  

예제는 

- 순수JPA 사용 예제
- Spring Data JPA 를 사용 예제

의 예제를 들어서 차이점을 비교할 예정이다.  

## 순수 JPA 사용예제

### repository

```java
public List<Employee> findByUsernameAndDeptNo(String username, int deptno){
  return 
    em.createQuery("select e from Employee e where e.username = :username and e.deptno = :deptno")
    	.setParameter("username", username)
    	.setParameter("age", age)
    	.getResultList();
}
```



### test

```java
public void TestEmployeeJPA {
  // ...
  @Test
  public void findByUsernameAndDeptNo (){
    Employee e1 = new Employee("경찰관1", 112);
    Employee e2 = new Employee("소방관1", 119);
    empRepository.save(e1);
    empRepository.save(e2);
    
    List<Member> result = 
      empRepository.findByUsernameAndDeptNo("경찰관1", 112);
    assertThat(result.get(0).getUsername()).isEqualTo("경찰관1");
    assertThat(result.get(0).getDeptNo()).isEqualTo(112);
    assertThat(result.size()).isEqualTo(1);
  }
}
```



## 스프링 데이터 JPA

### 예제

스프링 데이터 JPA는 메서드 이름에 명시한 필드 명과 And, Or 등을 분석해서 JPQL을 생성하고 실행한다. (내부적으로는 reflection을 사용하는 것으로 보인다.) IDE의 자동완성의 도움을 받아서 작성할 수 있다.

```java
public interface EmpDataRepository extends JpaRepository<Employee, Long> {
  List<Member> findByUsernameAndDeptNo(String username, int age);
}
```



쿼리 메서드 이름을 분석해서 where 절에 조건절을 다는 필터링 방식에 대한 공식문서는 https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods.query-creation 에 있으니 참고하자.  

  

### 주의

주의 해야 하는 점이 있다. 엔티티의 필드 명을 변경할 경우 리포지터리내에 해당 필드가 포함된 모든 메서드를 수정해야 한다. 수정하지 않으면 컴파일 타임에 미리 빨간 줄로 에러를 내므로, 일일이 찾아서 수정하는 것이 그리 불편한 점은 아니다. 런타임에 에러를 내지 않는다는 것만으로도 감사하다.



### 세부 쿼리

우리는 Spring Data JPA를 쓰고 있다. 하지만, SQL을 날린다는 사실에는 변함이 없다. 어떤 SQL을 날리는지 이해하고 사용해야 한다. 여기에 대한 공식문서들 및 기본적인 SQL 예약함수 들에 대한 Data JPA의 함수를 정리해보면 아래와 같다.  

- 조회
  - findXXXBy, readXXXBy, queryXXXBy, getXXXBy
  - 참고자료 - [https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.query-methods.query-creation](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.query-methods.query-creation)
- COUNT
  - countXXXBy
  - 반환 타입 : long
- EXISTS
  - existsXXXBy
  - 반환 타입 : boolean
- 삭제
  - deleteXXXBy, removeXXXBy
  - 반환 타입 : long
- DISTINCT
  - findDistinct, findEmployeeDistinctBy
- LIMIT
  - findFirst3, findFirst, findTop, findTop3
  - https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repositories.limit-query-result



# 2. JPA NamedQuery

@NamedQuery 어노테이션으로 쿼리에 이름을 붙여서 정의할 수 있다.  



# 3. @Query 어노테이션 - 리포지터리 메서드에 쿼리 정의



