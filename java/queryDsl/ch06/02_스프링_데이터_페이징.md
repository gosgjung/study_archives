# 스프링 데이터 페이징 

페이징은 페이지네이션 또는 페이징 이런 용어로 업계에서 자주 통용되는 단어이다. 보통 웹 계층관련 로직 구현 시 페이징 기능은 꼭 거쳐야 하는 과정 중 하나이다. 



# 간단한 페이징

굉장히 간단한 페이징을 작성해보자. QueryDsl에서 제공하는 기본 페이징 기능을 사용하는 형식은 아래와 같다. (페이징 기능을 최적화 없이 그대로 사용할 때의 예제)  

```java
// ...
public Page<MemberTeamDto> searchPageSimple(MemberSearchCondition condition, Pageable pageable){
  
  QueryResults<QSomeDto> fetchResults = 
    queryFactory
      .select( new QSomeDto(....) )
      .from( QSomeType.somefield )
      .leftJoin(member.team, team)
      .where(
        ...
      )
      .limit(pageable.getPageSize())
      .offset(pageable.getOffset())
      .fetchResults();
}
```

**Pageable pageable**  

- 스프링 부트에서는 Pageable을 제공한다.
- 요청에 대해 페이징과 관련된 요청은 Pageable로 분류되게 된다.

**offset, limit**  

- offset
  - 몇 번째 구간의 페이지를 보여줄지를 나타낸다. (1페이지, 2페이지 ....)
  - 0... i ... n-1의 형식이다.
- limit
  - 데이터를 몇개 단위로 묶을지를 나타낸다.
  - 만약 30을 지정했다면 30단위로 여러개의 페이지가 생성된다.

  

으아아아아... 저녁에 정리하자....  

- 실제 생성되는 쿼리
- 쿼리가 몇번수행되는지 등



이전 문서(Spring Data JPA with QueryDsl)에서 작성한 MemberJpaCustom, MemberJpaCustomImpl 을 수정하여 사용하자.  

**MemberJpaCustom.java**

```java
package com.study.qdsl.repository.custom;

import static com.study.qdsl.entity.QMember.*;
import static com.study.qdsl.entity.QTeam.*;
import static org.springframework.util.StringUtils.*;

import com.querydsl.core.QueryResults;
import com.querydsl.core.types.dsl.BooleanExpression;
import com.querydsl.jpa.impl.JPAQuery;
import com.querydsl.jpa.impl.JPAQueryFactory;
import com.study.qdsl.dto.MemberTeamDto;
import com.study.qdsl.dto.QMemberTeamDto;
import com.study.qdsl.dto.condition.MemberSearchCondition;
import com.study.qdsl.entity.Member;
import com.study.qdsl.entity.QMember;
import com.study.qdsl.entity.QTeam;
import java.util.List;
import javax.persistence.EntityManager;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.Pageable;
import org.springframework.data.repository.support.PageableExecutionUtils;
import org.springframework.util.StringUtils;

/**
 * ch06-item2-QueryDsl 지원 커스텀 리포지터리 만들기
 */
public class MemberJpaCustomImpl implements MemberJpaCustom {

	private final EntityManager em;
	private final JPAQueryFactory queryFactory;

	public MemberJpaCustomImpl(EntityManager em){
		this.em = em;
		queryFactory = new JPAQueryFactory(em);
	}
  
	// ...

	/** ch06-item3-스프링 데이터 페이징 활용1 - QueryDsl 페이징 연동
	 * limit(), offset() 을 통해 페이지네이션을 적용한다.
	 * fetchResults() 를 통해 결과를 얻어낸다.
	 *
	 * fetchResults() 가 호출 될때
	 *  - 실제 쿼리는 두번 호출된다. (컨텐츠 쿼리 + 카운트 쿼리)
	 *  - 카운트 쿼리 실행시 필요없는 order by는 제거된다.
	 * */
	@Override
	public Page<MemberTeamDto> searchPageSimple(MemberSearchCondition condition, Pageable pageable) {
		QueryResults<MemberTeamDto> fetchResults = queryFactory
			.select(new QMemberTeamDto(
				member.id.as("memberId"),
				member.username,
				member.age,
				member.team.id.as("teamId"),
				member.team.name.as("teamName")
			))
			.from(member)
			.leftJoin(member.team, team)
			.where(
				userNameEq(condition),
				teamNameEq(condition),
				ageGoe(condition),
				ageLoe(condition)
			)
			.limit(pageable.getPageSize())
			.offset(pageable.getOffset())
			.fetchResults(); // fetchResults() 를 사용하면 content 쿼리와 count 쿼리 두번을 호출한다.

		List<MemberTeamDto> results = fetchResults.getResults();
		long total = fetchResults.getTotal();
		return new PageImpl<MemberTeamDto>(results, pageable, total);
	}
  
	// ... 
  	private BooleanExpression userNameEq(MemberSearchCondition condition){
		return hasText(condition.getUsername()) ? member.username.eq(condition.getUsername()) : null;
	}

	private BooleanExpression teamNameEq(MemberSearchCondition condition){
		return hasText(condition.getTeamName()) ? team.name.eq(condition.getTeamName()) : null;
	}

	private BooleanExpression ageGoe(MemberSearchCondition condition){
		return condition.getAgeGoe() == null ? null : member.age.goe(condition.getAgeGoe());
	}

	private BooleanExpression ageLoe(MemberSearchCondition condition){
		return condition.getAgeLoe() == null ? null : member.age.loe(condition.getAgeLoe());
	}

	private BooleanExpression ageBetween(MemberSearchCondition condition){
		return member.age.between(condition.getAgeGoe(), condition.getAgeLoe());
	}
  
}

```





# 최적화 (1) - count 쿼리 분리

