# 동적 쿼리

MyBatis를 사용할 때도 동적 쿼리는 SQL의 "꽃"이었던것 같다^^  

MyBatis로 질리도록 많이 써봤으니깐 QueryDsl로 해보는 방법도 익혀보자~  

QueryDsl에서 동적 쿼리를 사용하는 방식은 2가지가 있다.

- BooleanBuilder
- Where 절에서 다중 파라미터 사용

  

동적쿼리를 조금 더 심화해서 발전해나가다 보면 비교식을 제품의 특성과 연관지어서 아래와 같이 다양한 활용이 가능하게 된다.  

- 하나의 클래스로 묶거나
- 객체로 생성할 수도 있고
- 컴포지션을 만들수도 있다.

  

# BooleanBuilder

- BooleanBuilder 에 조건식 BooleanExpression 을 넣어준다.
- 파라미터가 null 이 아닐 경우에 한해 eq(), gt(), goe(), lt(), loe(), ... 의 비교표현식이 동작한다.

## 예제1) 단순 동적 쿼리

```java
import javax.transaction.Transactional;
import org.springframework.boot.test.context.SpringBootTest;
import javax.persistence.EntityManager;

import static com.study.qdsl.entity.QMember.*;
import static org.assertj.core.api.Assertions.*;

@SpringBootTest
@Transactional
public class QdslDynamicSqlBooleanBuilderTest{
  @Autowired
  EntityManager em;
  
  JPAQueryFactory queryFactory;
  
  // ...
  
  @Test
  public void dynamicSqlByBooleanBuilder1(){
    String username = "Genie";
    Integer age = null;
    
    List<Member> result = searchMemberByBuilder(username, age);
    assertThat(result.size()).isEqualTo(2);
  }
  
  private List<Member> searchMemberByBuilder(String usernameCond, Integer ageCond){
    BooleanBuilder builder = new BooleanBuilder();
    
    if(usernameCond != null){
      builder.and(member.username.eq(usernameCond));
    }
    
    if(ageCond != null){
      builder.and(member.age.eq(ageCond));
    }
    
    return queryFactory.selectFrom(member)
      	.where(builder)
      	.fetch();
  }
}
```

- queryDsl을 이용한 SQL 로직을 따로 메서드로 분리해 작성했다.
- dynamicSqlByBooleanBuilder1(){...}
  - 검색조건 파라미터인 username, age 를 초기화한다.
  - queryDsl을 이용한 SQL 연산을 수행하는 함수인 searchMemberByBuilder(...)을 호출하고 있다.
- searchMemberByBuilder(...){...}
  - BooleanBuilder 인스턴스를 생성해 이 인스턴스로 파라미터 username, age의 조건식을 검사한다.
  - BooleanBuilder 의 and()를 이용해 필요한 조건 검사를 조립한다.
  - null 처리에 유의해서 작성하자.
  - 조건 검사가 끝난 후 queryDsl을 통해 쿼리를 수행한다.



## 예제2) 필수체크 조건값 검사

파라미터가 null로 넘어오지 않는 다는 가정하에 필수로 비교식을 수행해야 하는 경우가 있다. 이런 경우에는 BooleanExpression을 사용한다.  

```java
import javax.transaction.Transactional;
import org.springframework.boot.test.context.SpringBootTest;
import javax.persistence.EntityManager;
import com.querydsl.core.types.dsl.BooleanExpression;

import static com.study.qdsl.entity.QMember.*;
import static org.assertj.core.api.Assertions.*;

@SpringBootTest
@Transactional
public class QdslDynamicSqlBooleanBuilderTest{
  @Autowired
  EntityManager em;
  
  JPAQueryFactory queryFactory;
  
  // ...
  
  @Test
  public void dynamicSqlByBooleanBuilder2(){
    String username = "Genie";
    Integer age = null;
    
    List<Member> result = searchMemberByBuilder2(username, age);
    assertThat(result.size()).isEqualTo(2);
  }
  
  private List<Member> searchMemberByBuilder2(String usernameCond, Integer ageCond){
    // 이 부분이다. 필수 체크해야 하는 조건값이 age일 경우에 대해서 null 체크 없이 바로 조건 검사를 수행한다.
    BooleanExpression expr = member.age.eq(ageCond);
    BooleanBuilder builder = new BooleanBuilder(expr);
    // 필수 체크 조건값이 여러개일 경우는 expr에 여러개의 조건을 and, or 등을 통해 조합하여 사용할 수 있다.
    
    // 위의 두 라인은 아래와 같이 바꿀 수 있다.
    // BooleanBuilder builder = new BooleanBuilder(member.age.eq(ageCond));
    
    if(usernameCond != null){
      builder.and(member.username.eq(usernameCond));
    }
    
    return queryFactory.selectFrom(member)
      	.where(builder)
      	.fetch();
  }
}
```



# Where 절 다중 조건 활용





